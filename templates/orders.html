<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        html, body {
          height: 100%;
          overflow: hidden;
        }
        body {
          min-height: 100vh;
          height: 100vh;
          font-family: 'Segoe UI', Arial, sans-serif;
          background: #ffffff;
          color: #222;
          margin: 0;
          padding: 0 0 40px 0;
          font-size: 14px;
          text-align: left;
        }
        nav {
            width: 210px;
            min-width: 210px;
            max-width: 210px;
            min-height: 100vh;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: #f1f1f1;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 24px 0 0 0;
            gap: 8px;
            z-index: 1000;
            justify-content: space-between;
            transition: min-width 0.2s, width 0.2s, max-width 0.2s, padding 0.2s;
        }
        .nav-logo {
            width: 120px;
            margin: 10px auto 18px auto;
            display: block;
            opacity: 0.85;
            padding-bottom: 30px;
        }
        .nav-btns {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }
        .nav-submenu {
            display: none;
            flex-direction: column;
            position: absolute;
            left: 210px;
            top: 2px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            z-index: 2000;
            min-width: 160px;
        }
        .nav-submenu button {
            background: none;
            border: none;
            color: #333;
            font-size: 16px;
            padding: 10px 18px;
            text-align: left;
            border-radius: 0;
            cursor: pointer;
            opacity: 1;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        .nav-submenu button:hover {
            background: #f1f1f1;
        }
        nav.collapsed {
            width: 48px;
            min-width: 48px;
            max-width: 48px;
            transition: width 0.2s, min-width 0.2s, max-width 0.2s;
        }
        nav.collapsed .nav-btns,
        nav.collapsed .nav-logo,
        nav.collapsed .nav-submenu {
            display: none !important;
        }
        .collapse-arrow {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1101;
            box-shadow: 0 1px 4px rgba(0,0,0,0.07);
            transition: background 0.15s;
        }
        .collapse-arrow:hover {
            background: #d1d5db;
        }
        .collapse-arrow svg {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
        }
        nav.collapsed + .main-content {
            margin-left: 48px !important;
            transition: margin-left 0.2s;
        }
        .main-content {
          flex: 1;
          display: flex;
          flex-direction: column;
          margin-left: 210px;
          overflow: hidden;
          padding-right: 40px;
          height: 100vh;
          min-height: 0;
        }
        .table-wrapper {
          flex: 1 1 auto;
          max-height: calc(100vh - 120px);
          min-height: 0;
          overflow-y: auto;
          overflow-x: auto;
          margin: 0 0 28px 40px;
          border-radius: 5px;
          background: #fff;
        }
        body {
          font-family: 'Segoe UI', Arial, sans-serif;
          background: #ffffff;
          color: #222;
          margin: 0;
          padding: 0 0 40px 0;
          font-size: 14px;
          text-align: left;
        }
        h1 {
          margin-top: 32px;
          margin-bottom: 24px;
          padding-left: 40px;
          font-size: 18px;
          font-weight: 600;
          color: #000000;
          text-align: left;
        }
        table {
          border-collapse: separate;
          border-spacing: 0;
          width: auto;
          min-width: 100%;
          margin: 0;
          background: #fff;
          border-radius: 5px;
          font-size: 14px;
          text-align: left;
          table-layout: auto;
          border: 1px solid #e5e7eb;
        }
        thead tr {
          background: #dbeafe;
          position: sticky;
          top: 0;
          z-index: 2;
        }
        th, td {
          border: 1px solid #e5e7eb !important;
          background-clip: padding-box;
        }
        /* Set explicit min-width for each column to force minimum width, but allow expansion */
        th:nth-child(1), td:nth-child(1) { min-width: 70px; }
        th:nth-child(2), td:nth-child(2) { min-width: 100px; }
        th:nth-child(3), td:nth-child(3) { min-width: 120px; }
        th:nth-child(4), td:nth-child(4) { min-width: 130px; }
        th:nth-child(5), td:nth-child(5) { min-width: 250px; }
        th:nth-child(6), td:nth-child(6) { min-width: 160px; }
        th:nth-child(7), td:nth-child(7) { min-width: 300px; }
        th:nth-child(8), td:nth-child(8) { min-width: 300px; }
        th:nth-child(9), td:nth-child(9) { min-width: 130px; }
        th:nth-child(10), td:nth-child(10) { min-width: 130px; }
        th:nth-child(11), td:nth-child(11) { min-width: 80px; }
        pre {
          margin: 0;
          overflow-y: auto;
          white-space: pre;
        }
        tr:nth-child(even) td {
          background: #f4f6fa;
        }
        tr:hover td {
          background: #eaf1fb;
          transition: background 0.2s;
        }
        .summary-table th {
          background: #000000;
          font-size: 14px;
          text-align: left;
        }
        .summary-table td {
          font-weight: 500;
          color: #000000;
          background: #f7f8fa;
          font-size: 14px;
          text-align: left;
        }
        .summary-table {
          margin-bottom: 12px;
          margin-left: 40px;
          width: 45%;
          font-size: 14px;
          text-align: left;
        }
        .error {
          color: #d32f2f;
          background: #fff0f0;
          border: 1px solid #f8bcbc;
          padding: 10px 18px;
          border-radius: 6px;
          width: 80%;
          margin: 18px auto;
          text-align: left;
          font-size: 14px;
        }
        .bubble {
          display: inline-block;
          background: #17633a;
          color: #fff;
          border-radius: 16px;
          padding: 2px 10px;
          margin: 2px 0;
          font-weight: 500;
          font-size: 13px;
        }
        .bubble-light {
          display: inline-block;
          background: #d6f8c5;
          color: #222;
          border-radius: 16px;
          padding: 2px 10px;
          margin: 2px 0;
          font-weight: 500;
          font-size: 13px;
        }
        .bubble-gray {
          display: inline-block;
          background: #e5e7eb;
          color: #222;
          border-radius: 16px;
          padding: 2px 10px;
          margin: 2px 0;
          font-weight: 500;
          font-size: 13px;
        }
        .dropdown-menu {
          font-size: 14px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .dropdown-option {
          padding: 8px 16px;
          cursor: pointer;
          color: #222;
          background: #fff;
          border-bottom: 1px solid #e5e7eb;
          transition: background 0.15s;
        }
        .dropdown-option:last-child {
          border-bottom: none;
        }
        .dropdown-option:hover {
          background: #dbeafe;
        }
        .fulfillment-bubble:focus {
          outline: 2px solid #17633a;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .bubble-fulfillment-completed {
          background: #d6f8c5 !important;
          color: #17633a !important;
        }
        .bubble-fulfillment-processing {
          background: #fff9c4 !important;
          color: #b59b00 !important;
        }
        .bubble-fulfillment-received {
          background: #ffe0b2 !important;
          color: #b26a00 !important;
        }
        .bubble-fulfillment-canceled {
          background: #ffcdd2 !important;
          color: #b71c1c !important;
        }
        .info-badge {
          display: inline-block;
          background: #e0e7ff;
          color: #374151;
          border-radius: 50%;
          width: 18px;
          height: 18px;
          font-size: 14px;
          text-align: center;
          line-height: 18px;
          cursor: pointer;
          position: relative;
          margin-left: 6px;
          border: 1px solid #b6b6b6;
          font-weight: bold;
        }
        .info-badge:focus {
          outline: 2px solid #17633a;
        }
        .info-tooltip {
          display: none;
          position: absolute;
          left: 50%;
          top: 120%;
          transform: translateX(-50%);
          background: #222;
          color: #fff;
          padding: 8px 14px;
          border-radius: 7px;
          font-size: 13px;
          white-space: nowrap;
          z-index: 100;
          box-shadow: 0 2px 8px rgba(0,0,0,0.13);
          pointer-events: none;
        }
        .info-badge:hover .info-tooltip,
        .info-badge:focus .info-tooltip {
          display: block;
        }
    </style>
    <script>
        function setFulfillmentBubbleColor(bubble, status) {
          bubble.classList.remove(
            'bubble-fulfillment-completed',
            'bubble-fulfillment-processing',
            'bubble-fulfillment-received',
            'bubble-fulfillment-canceled'
          );
          if (status === 'Completed') {
            bubble.classList.add('bubble-fulfillment-completed');
          } else if (status === 'Processing') {
            bubble.classList.add('bubble-fulfillment-processing');
          } else if (status === 'Received') {
            bubble.classList.add('bubble-fulfillment-received');
          } else if (status === 'Canceled') {
            bubble.classList.add('bubble-fulfillment-canceled');
          }
        }
        document.addEventListener('DOMContentLoaded', function() {
            // Collapse navigation logic
            const nav = document.getElementById('admin-nav');
            const arrow = document.getElementById('collapse-arrow');
            let collapsed = false;
            function setArrowDirection() {
                const svg = arrow.querySelector('svg');
                if (collapsed) {
                    svg.style.transform = 'rotate(180deg)';
                    arrow.title = 'Expand navigation';
                } else {
                    svg.style.transform = '';
                    arrow.title = 'Collapse navigation';
                }
            }
            function toggleNav() {
                collapsed = !collapsed;
                nav.classList.toggle('collapsed', collapsed);
                setArrowDirection();
            }
            arrow.addEventListener('click', toggleNav);
            arrow.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleNav();
                }
            });
            setArrowDirection();
            // Profit Reports submenu logic
            const profitBtn = document.getElementById('profit-reports-btn');
            const submenu = document.getElementById('profit-reports-submenu');
            let submenuTimeout;
            profitBtn.addEventListener('mouseenter', function() {
                clearTimeout(submenuTimeout);
                submenu.style.display = 'flex';
            });
            profitBtn.addEventListener('mouseleave', function() {
                submenuTimeout = setTimeout(() => submenu.style.display = 'none', 200);
            });
            submenu.addEventListener('mouseenter', function() {
                clearTimeout(submenuTimeout);
                submenu.style.display = 'flex';
            });
            submenu.addEventListener('mouseleave', function() {
                submenuTimeout = setTimeout(() => submenu.style.display = 'none', 200);
            });
            document.querySelectorAll('.fulfillment-bubble').forEach(function(bubble) {
              setFulfillmentBubbleColor(bubble, bubble.textContent.trim());
            });
            // Restore: Make order total editable (only bubbles with $ and not Quantity:)
            document.querySelectorAll('td span.bubble').forEach(function(bubble) {
              if (
                bubble.textContent.trim().startsWith('$') &&
                !bubble.textContent.trim().startsWith('Quantity:') &&
                !bubble.dataset.hasOwnProperty('items') // not a quantity bubble
              ) {
                var tr = bubble.closest('tr');
                var orderIdSpan = tr ? tr.querySelector('span[data-order-id]') : null;
                var orderId = orderIdSpan ? orderIdSpan.getAttribute('data-order-id') : null;
                if (orderId) {
                  bubble.style.cursor = 'pointer';
                  bubble.addEventListener('click', function(e) {
                    if (!bubble.dataset.editing) {
                      makeOrderTotalEditable(bubble, orderId, bubble.textContent.trim());
                    }
                  });
                }
              }
            });
            // Make item and flower quantities editable (only bubbles with Quantity:)
            document.querySelectorAll('span.bubble').forEach(function(bubble) {
              if (bubble.textContent.trim().startsWith('Quantity:')) {
                let td = bubble.closest('td');
                let isFlower = false;
                // Check if this is in the flower column by looking for 'g' after the quantity
                if (bubble.textContent.trim().endsWith('g')) {
                  isFlower = true;
                } else if (td && td.previousElementSibling && td.previousElementSibling.textContent.includes('Flower')) {
                  isFlower = true;
                }
                let orderTr = bubble.closest('tr');
                let orderIdSpan = orderTr ? orderTr.querySelector('span[data-order-id]') : null;
                let orderId = orderIdSpan ? orderIdSpan.getAttribute('data-order-id') : null;
                if (!orderId) return;
                // Use data-items and data-index for correct array and index
                let itemsArray = bubble.dataset.items ? JSON.parse(bubble.dataset.items) : null;
                let itemIndex = bubble.dataset.index ? parseInt(bubble.dataset.index) : null;
                if (!itemsArray || itemIndex === null || isNaN(itemIndex)) return;
                bubble.style.cursor = 'pointer';
                bubble.addEventListener('click', function(e) {
                  if (!bubble.dataset.editing) {
                    let val = bubble.textContent.replace(/[^\d.]/g, '');
                    makeQuantityEditable(bubble, orderId, itemIndex, isFlower, val, itemsArray);
                  }
                });
              }
            });
        });
        function toggleDropdown(el) {
          var menu = el.parentElement.querySelector('.dropdown-menu');
          var isOpen = menu.style.display === 'block';
          document.querySelectorAll('.dropdown-menu').forEach(function(m) { m.style.display = 'none'; });
          menu.style.display = isOpen ? 'none' : 'block';
        }
        document.addEventListener('click', function(e) {
          if (!e.target.classList.contains('fulfillment-bubble')) {
            document.querySelectorAll('.dropdown-menu').forEach(function(m) { m.style.display = 'none'; });
          }
        });
        function selectFulfillment(optionEl, value) {
          var bubble = optionEl.closest('.fulfillment-dropdown').querySelector('.fulfillment-bubble');
          var orderId = bubble.getAttribute('data-order-id');
          var originalText = bubble.textContent;
          // Show spinner
          bubble.innerHTML = '<span class="spinner" style="display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top:2px solid #17633a;border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;"></span>';
          optionEl.parentElement.style.display = 'none';
          const start = Date.now();
          fetch('/update-fulfillment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ order_id: orderId, status: value }),
          })
          .then(response => response.json())
          .then(data => {
            const elapsed = Date.now() - start;
            const minDelay = 500;
            const finish = () => {
              if (!data.success) {
                alert('Failed to update fulfillment status.');
                bubble.textContent = originalText;
                setFulfillmentBubbleColor(bubble, originalText.trim());
              } else {
                bubble.textContent = value;
                setFulfillmentBubbleColor(bubble, value);
              }
            };
            if (elapsed < minDelay) {
              setTimeout(finish, minDelay - elapsed);
            } else {
              finish();
            }
          })
          .catch(() => {
            const elapsed = Date.now() - start;
            const minDelay = 500;
            const finish = () => {
              alert('Error updating fulfillment status.');
              bubble.textContent = originalText;
              setFulfillmentBubbleColor(bubble, originalText.trim());
            };
            if (elapsed < minDelay) {
              setTimeout(finish, minDelay - elapsed);
            } else {
              finish();
            }
          });
        }
        function makeOrderTotalEditable(bubble, orderId, originalValue) {
          if (bubble.dataset.editing === 'true') return;
          bubble.dataset.editing = 'true';
          const input = document.createElement('input');
          input.type = 'number';
          input.step = '0.01';
          input.value = originalValue.replace(/[^\d.\-]/g, '');
          input.style.width = '70px';
          input.style.fontSize = '13px';
          input.style.borderRadius = '8px';
          input.style.border = '1px solid #ccc';
          input.style.padding = '2px 6px';
          input.style.margin = '0';
          input.style.boxSizing = 'border-box';
          bubble.innerHTML = '';
          bubble.appendChild(input);
          input.focus();
          input.select();
          function formatCurrency(val, fallback) {
            var num = parseFloat(val);
            if (isNaN(num)) return fallback;
            return `$${num.toFixed(2)}`;
          }
          function finishEdit(save) {
            if (!bubble.dataset.editing) return;
            bubble.dataset.editing = '';
            let newValue = input.value;
            if (save && newValue && newValue !== originalValue.replace(/[^\d.\-]/g, '')) {
              // Show spinner
              bubble.innerHTML = '<span class="spinner" style="display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top:2px solid #17633a;border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;"></span>';
              const start = Date.now();
              fetch('/update-fulfillment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: orderId, status: null, total: newValue }),
              })
              .then(response => response.json())
              .then(data => {
                const elapsed = Date.now() - start;
                const minDelay = 500;
                const finish = () => {
                  if (!data.success) {
                    alert('Failed to update order total.');
                    bubble.innerHTML = formatCurrency(originalValue.replace(/[^\d.\-]/g, ''), originalValue);
                  } else {
                    bubble.innerHTML = formatCurrency(newValue, originalValue);
                  }
                };
                if (elapsed < minDelay) {
                  setTimeout(finish, minDelay - elapsed);
                } else {
                  finish();
                }
              })
              .catch(() => {
                bubble.innerHTML = formatCurrency(originalValue.replace(/[^\d.\-]/g, ''), originalValue);
                alert('Error updating order total.');
              });
            } else {
              bubble.innerHTML = formatCurrency(originalValue.replace(/[^\d.\-]/g, ''), originalValue);
            }
          }
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              finishEdit(true);
            } else if (e.key === 'Escape') {
              finishEdit(false);
            }
          });
          input.addEventListener('blur', function() { finishEdit(true); });
        }
        function makeQuantityEditable(bubble, orderId, itemIndex, isFlower, originalValue, itemsArray) {
          if (bubble.dataset.editing === 'true') return;
          bubble.dataset.editing = 'true';
          // Save the label (e.g., 'Quantity:' or 'Quantity: 3g')
          let label = bubble.innerHTML.match(/<b>Quantity:<\/b>/) ? '<b>Quantity:</b> ' : '';
          // Remove label and units from value
          let valueOnly = originalValue;
          if (label) {
            valueOnly = bubble.textContent.replace(/[^\d.]/g, '');
          }
          const input = document.createElement('input');
          input.type = 'number';
          input.step = '1';
          input.min = '1';
          input.value = valueOnly;
          input.style.width = '60px';
          input.style.fontSize = '13px';
          input.style.borderRadius = '8px';
          input.style.border = '1px solid #ccc';
          input.style.padding = '2px 6px';
          input.style.margin = '0';
          input.style.boxSizing = 'border-box';
          bubble.innerHTML = label;
          bubble.appendChild(input);
          input.focus();
          input.select();
          function finishEdit(save) {
            if (!bubble.dataset.editing) return;
            bubble.dataset.editing = '';
            let newValue = input.value;
            if (save && newValue && newValue !== originalValue) {
              let updatedArray = JSON.parse(JSON.stringify(itemsArray));
              updatedArray[itemIndex]['quantity'] = isFlower ? parseFloat(newValue) : parseInt(newValue);
              bubble.innerHTML = label + '<span class="spinner" style="display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top:2px solid #17633a;border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;"></span>';
              const start = Date.now();
              let body = { order_id: orderId };
              if (isFlower) {
                body['flower'] = updatedArray;
              } else {
                body['items'] = updatedArray;
              }
              fetch('/update-fulfillment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
              })
              .then(response => response.json())
              .then(data => {
                const elapsed = Date.now() - start;
                const minDelay = 500;
                const finish = () => {
                  if (!data.success) {
                    bubble.innerHTML = label + originalValue + (isFlower ? 'g' : '');
                    alert('Failed to update quantity.');
                  } else {
                    bubble.innerHTML = label + newValue + (isFlower ? 'g' : '');
                  }
                };
                if (elapsed < minDelay) {
                  setTimeout(finish, minDelay - elapsed);
                } else {
                  finish();
                }
              })
              .catch(() => {
                bubble.innerHTML = label + originalValue + (isFlower ? 'g' : '');
                alert('Error updating quantity.');
              });
            } else {
              bubble.innerHTML = label + originalValue + (isFlower ? 'g' : '');
            }
          }
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              finishEdit(true);
            } else if (e.key === 'Escape') {
              finishEdit(false);
            }
          });
          input.addEventListener('blur', function() { finishEdit(true); });
        }
        document.addEventListener('DOMContentLoaded', function() {
          // Profit Reports submenu logic
          const profitBtn = document.getElementById('profit-reports-btn');
          const submenu = document.getElementById('profit-reports-submenu');
          let submenuTimeout;
          profitBtn.addEventListener('mouseenter', function() {
              clearTimeout(submenuTimeout);
              submenu.style.display = 'flex';
          });
          profitBtn.addEventListener('mouseleave', function() {
              submenuTimeout = setTimeout(() => submenu.style.display = 'none', 200);
          });
          submenu.addEventListener('mouseenter', function() {
              clearTimeout(submenuTimeout);
              submenu.style.display = 'flex';
          });
          submenu.addEventListener('mouseleave', function() {
              submenuTimeout = setTimeout(() => submenu.style.display = 'none', 200);
          });
          document.querySelectorAll('.fulfillment-bubble').forEach(function(bubble) {
            setFulfillmentBubbleColor(bubble, bubble.textContent.trim());
          });
          // Restore: Make order total editable (only bubbles with $ and not Quantity:)
          document.querySelectorAll('td span.bubble').forEach(function(bubble) {
            if (
              bubble.textContent.trim().startsWith('$') &&
              !bubble.textContent.trim().startsWith('Quantity:') &&
              !bubble.dataset.hasOwnProperty('items') // not a quantity bubble
            ) {
              var tr = bubble.closest('tr');
              var orderIdSpan = tr ? tr.querySelector('span[data-order-id]') : null;
              var orderId = orderIdSpan ? orderIdSpan.getAttribute('data-order-id') : null;
              if (orderId) {
                bubble.style.cursor = 'pointer';
                bubble.addEventListener('click', function(e) {
                  if (!bubble.dataset.editing) {
                    makeOrderTotalEditable(bubble, orderId, bubble.textContent.trim());
                  }
                });
              }
            }
          });
          // Make item and flower quantities editable (only bubbles with Quantity:)
          document.querySelectorAll('span.bubble').forEach(function(bubble) {
            if (bubble.textContent.trim().startsWith('Quantity:')) {
              let td = bubble.closest('td');
              let isFlower = false;
              // Check if this is in the flower column by looking for 'g' after the quantity
              if (bubble.textContent.trim().endsWith('g')) {
                isFlower = true;
              } else if (td && td.previousElementSibling && td.previousElementSibling.textContent.includes('Flower')) {
                isFlower = true;
              }
              let orderTr = bubble.closest('tr');
              let orderIdSpan = orderTr ? orderTr.querySelector('span[data-order-id]') : null;
              let orderId = orderIdSpan ? orderIdSpan.getAttribute('data-order-id') : null;
              if (!orderId) return;
              // Use data-items and data-index for correct array and index
              let itemsArray = bubble.dataset.items ? JSON.parse(bubble.dataset.items) : null;
              let itemIndex = bubble.dataset.index ? parseInt(bubble.dataset.index) : null;
              if (!itemsArray || itemIndex === null || isNaN(itemIndex)) return;
              bubble.style.cursor = 'pointer';
              bubble.addEventListener('click', function(e) {
                if (!bubble.dataset.editing) {
                  let val = bubble.textContent.replace(/[^\d.]/g, '');
                  makeQuantityEditable(bubble, orderId, itemIndex, isFlower, val, itemsArray);
                }
              });
            }
          });
          // --- Flower Dropdown for Duplicate Row ---
          const flowerDropdown = document.getElementById('flower-dropdown-duplicate');
          const flowerSearchInput = document.getElementById('flower-search-input');
          let allFlowers = [];
          if (flowerDropdown) {
            flowerDropdown.innerHTML = '<option value="" disabled selected>Loading flowers...</option>';
            fetch('/api/all-flower-options')
              .then(resp => resp.json())
              .then(data => {
                allFlowers = data.flowers || [];
                renderFlowerDropdown('');
              })
              .catch(() => {
                flowerDropdown.innerHTML = '';
                var opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Error loading flowers';
                opt.disabled = true;
                opt.selected = true;
                flowerDropdown.appendChild(opt);
              });
          }
          function renderFlowerDropdown(filterText) {
            flowerDropdown.innerHTML = '';
            let filtered = allFlowers.filter(f =>
              f.id.toString().toLowerCase().includes(filterText.toLowerCase()) ||
              (f.product_name && f.product_name.toLowerCase().includes(filterText.toLowerCase()))
            );
            if (filtered.length === 0) {
              var opt = document.createElement('option');
              opt.value = '';
              opt.textContent = 'No flower products found';
              opt.disabled = true;
              opt.selected = true;
              flowerDropdown.appendChild(opt);
              return;
            }
            filtered.forEach(function(flower) {
              var option = document.createElement('option');
              option.value = flower.id;
              option.textContent = flower.id + ': ' + flower.product_name;
              flowerDropdown.appendChild(option);
            });
          }
          if (flowerSearchInput) {
            flowerSearchInput.addEventListener('input', function() {
              renderFlowerDropdown(this.value);
            });
          }

          // --- Product Dropdown for Add Row ---
          const productDropdown = document.getElementById('product-dropdown');
          const productSearchInput = document.getElementById('product-search-input');
          let allProducts = [];
          if (productDropdown) {
            // Gather all products from the select options
            allProducts = Array.from(productDropdown.options).map(opt => ({
              id: opt.value,
              product_name: opt.textContent.split(': ').slice(1).join(': ') || opt.textContent,
              fullText: opt.textContent,
              dataOptions: opt.getAttribute('data-options')
            }));
            renderProductDropdownSelect('');
          }
          function renderProductDropdownSelect(filterText) {
            productDropdown.innerHTML = '';
            let filtered = allProducts.filter(p =>
              p.id.toLowerCase().includes(filterText.toLowerCase()) ||
              p.product_name.toLowerCase().includes(filterText.toLowerCase())
            );
            if (filtered.length === 0) {
              var opt = document.createElement('option');
              opt.value = '';
              opt.textContent = 'No products found';
              opt.disabled = true;
              opt.selected = true;
              productDropdown.appendChild(opt);
              return;
            }
            filtered.forEach(function(product) {
              var option = document.createElement('option');
              option.value = product.id;
              option.textContent = product.fullText;
              if (product.dataOptions) option.setAttribute('data-options', product.dataOptions);
              productDropdown.appendChild(option);
            });
          }
          if (productSearchInput) {
            productSearchInput.addEventListener('input', function() {
              renderProductDropdownSelect(this.value);
            });
          }
        });
        function openNewOrderPopup() {
          let overlay = document.getElementById('new-order-overlay');
          let popup = document.getElementById('new-order-popup');
          if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'new-order-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(0,0,0,0.35)';
            overlay.style.zIndex = '3000';
            overlay.onclick = function(e) {
              if (e.target === overlay) closeNewOrderPopup();
            };
            document.body.appendChild(overlay);
          } else {
            overlay.style.display = 'block';
          }
          if (!popup) {
            popup = document.createElement('div');
            popup.id = 'new-order-popup';
            popup.style.position = 'fixed';
            popup.style.top = '50%';
            popup.style.left = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.background = '#fff';
            popup.style.padding = '48px 60px';
            popup.style.borderRadius = '18px';
            popup.style.boxShadow = '0 8px 32px rgba(0,0,0,0.18), 0 1.5px 8px rgba(0,0,0,0.10)';
            popup.style.zIndex = '4000';
            popup.style.minWidth = '480px';
            popup.style.minHeight = '340px';
            popup.style.width = '60vw';
            popup.style.height = '60vh';
            popup.style.maxWidth = '900px';
            popup.style.maxHeight = '90vh';
            popup.style.display = 'flex';
            popup.style.flexDirection = 'column';
            popup.innerHTML = `<button onclick='closeNewOrderPopup()' style='position:absolute;top:18px;right:24px;font-size:22px;background:none;border:none;cursor:pointer;color:#222;' aria-label='Close'>&times;</button>`;
            // Move the dropdown into the popup
            var dropdownContainer = document.getElementById('product-dropdown-container');
            if (dropdownContainer) {
              popup.appendChild(dropdownContainer);
              dropdownContainer.style.display = 'block';
            }
            overlay.appendChild(popup);
          } else {
            popup.style.display = 'flex';
            overlay.appendChild(popup);
            var dropdownContainer = document.getElementById('product-dropdown-container');
            if (dropdownContainer) {
              popup.appendChild(dropdownContainer);
              dropdownContainer.style.display = 'block';
            }
          }
        }
        function closeNewOrderPopup() {
          let overlay = document.getElementById('new-order-overlay');
          if (overlay) overlay.style.display = 'none';
          var dropdownContainer = document.getElementById('product-dropdown-container');
          if (dropdownContainer) dropdownContainer.style.display = 'none';
        }
    </script>
</head>
<body>
<div style="display: flex; min-height: 100vh;">
    <nav id="admin-nav">
        <div class="collapse-arrow" id="collapse-arrow" title="Collapse navigation" tabindex="0">
            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M13 5l-5 5 5 5" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="nav-btns">
            <button style="background: none; border: none; color: #333; font-size: 17px; padding: 14px 0; margin: 0 18px; border-radius: 5px; text-align: left; opacity: 0.7;" onclick="window.location.href='https://topcola.onrender.com/orders'; return false;">Orders</button>
            <button style="background: none; border: none; color: #333; font-size: 17px; padding: 14px 0; margin: 0 18px; border-radius: 5px; text-align: left; opacity: 0.7;" id="profit-reports-btn" type="button">Profit Reports</button>
            <div class="nav-submenu" id="profit-reports-submenu">
                <button onclick="window.location.href='/profits-reports/7'">7 Days</button>
                <button onclick="window.location.href='/profits-reports/14'">14 Days</button>
                <button onclick="window.location.href='/profits-reports/30'">30 Days</button>
                <button onclick="window.location.href='/profits-reports/60'">60 Days</button>
                <button onclick="window.location.href='/profits-reports/90'">90 Days</button>
                <button onclick="window.location.href='/profits-reports/365'">1 Year</button>
            </div>
            <button style="background: none; border: none; color: #333; font-size: 17px; padding: 14px 0; margin: 0 18px; border-radius: 5px; text-align: left; opacity: 0.7;" onclick="window.location.href='https://topcola.onrender.com/admin'; return false;">Admin</button>
            <button style="background: none; border: none; color: #333; font-size: 17px; padding: 14px 0; margin: 0 18px; border-radius: 5px; text-align: left; opacity: 0.7;" onclick="window.open('https://supabase.com/dashboard/project/otnrvaybkwsvzxgwfhfc/editor', '_blank'); return false;">Database</button>
        </div>
        <img src="/static/ndc.png" alt="Nicholson Digital Co." class="nav-logo" />
    </nav>
    <div class="main-content">
      <button onclick="openNewOrderPopup()" style="position: absolute; top: 32px; right: 60px; z-index: 1100; background: #000; color: #fff; border: none; border-radius: 7px; padding: 12px 28px; font-size: 16px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.10); cursor: pointer;">Create New Order</button>
      <div id="product-dropdown-container" style="display:none; margin-bottom:24px;">
        <h2 style="font-size:22px;font-weight:700;margin:0 0 18px 0;">Manually Create New Order</h2>
        <!-- Product Add Row -->
        <label for='product-dropdown' style='font-size:18px;font-weight:600;margin-bottom:12px;display:block;'>Select Product/Item:</label>
        <div style="display: flex; gap: 18px; align-items: center; margin-bottom: 18px;">
          <div style="position:relative;max-width:320px;width:320px;">
            <div style="display:flex;flex-direction:column;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-radius:10px;overflow:hidden;border:1.5px solid #b3c6e0;background:#fff;">
              <input id="product-search-input" type="text" placeholder="Search product..." autocomplete="off" style="font-size:16px;padding:10px 18px;border:none;border-bottom:1px solid #e5e7eb;width:100%;box-sizing:border-box;outline:none;border-radius:10px 10px 0 0;">
              <select id='product-dropdown' style='font-size:16px;padding:10px 18px;border:none;width:100%;box-sizing:border-box;outline:none;border-radius:0 0 10px 10px;background:#fff;'>
                {% for product in products|sort(attribute='id') %}
                  <option value='{{ product.id }}' data-options='{{ product.options|tojson|safe if product.options is defined else "[]" }}'>{{ product.id }}: {{ product.product_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <label for='quantity-dropdown' style='font-size:16px;font-weight:500;margin-left:8px;'>Qty:</label>
          <select id='quantity-dropdown' style='font-size:16px;padding:10px 18px;border-radius:7px;border:1.5px solid #b3c6e0;width:90px;'>
            {% for i in range(1, 21) %}
              <option value='{{ i }}'>{{ i }}</option>
            {% endfor %}
          </select>
          <label for='type-dropdown' style='font-size:16px;font-weight:500;margin-left:8px;'>Type:</label>
          <select id='type-dropdown' style='font-size:16px;padding:10px 18px;border-radius:7px;border:1.5px solid #b3c6e0;width:120px;'>
            <option value="" disabled selected>Select type</option>
          </select>
          <button id="add-to-cart-btn" style="margin-left:12px;padding:10px 24px;font-size:16px;border-radius:7px;background:#007bff;color:#fff;border:none;cursor:pointer;">Add to Cart</button>
        </div>
        <!-- Flower Add Row -->
        <label for='flower-dropdown-duplicate' style='font-size:18px;font-weight:600;margin:16px 0 12px 0;display:block;'>Select Flower:</label>
        <div style="display: flex; gap: 18px; align-items: center; margin-bottom: 18px;">
          <div style="position:relative;max-width:320px;width:320px;">
            <div style="display:flex;flex-direction:column;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-radius:10px;overflow:hidden;border:1.5px solid #b3c6e0;background:#fff;">
              <input id="flower-search-input" type="text" placeholder="Search flower..." autocomplete="off" style="font-size:16px;padding:10px 18px;border:none;border-bottom:1px solid #e5e7eb;width:100%;box-sizing:border-box;outline:none;border-radius:10px 10px 0 0;">
              <select id='flower-dropdown-duplicate' style='font-size:16px;padding:10px 18px;border:none;width:100%;box-sizing:border-box;outline:none;border-radius:0 0 10px 10px;background:#fff;'>
                <option value="" disabled selected>Loading flowers...</option>
              </select>
            </div>
          </div>
          <label for='quantity-dropdown-duplicate' style='font-size:16px;font-weight:500;margin-left:8px;'>Qty:</label>
          <select id='quantity-dropdown-duplicate' style='font-size:16px;padding:10px 18px;border-radius:7px;border:1.5px solid #b3c6e0;width:90px;'>
            {% for i in range(1, 21) %}
              <option value='{{ i }}'>{{ i }}</option>
            {% endfor %}
          </select>
          <button id="add-to-cart-btn-duplicate" style="margin-left:12px;padding:10px 24px;font-size:16px;border-radius:7px;background:#007bff;color:#fff;border:none;cursor:pointer;">Add to Cart</button>
        </div>
        <button onclick="window.open('/manual-cart', '_blank');" style="margin-top:18px;padding:12px 32px;font-size:17px;font-weight:600;border-radius:8px;background:#17633a;color:#fff;border:none;box-shadow:0 2px 8px rgba(0,0,0,0.10);cursor:pointer;">View Manually Created Cart</button>
      </div>
      <h1>All Orders</h1>
      {% if error %}
        <div class="error">{{ error }}</div>
      {% endif %}

      {% if orders and orders|length > 0 %}
        {% set sorted_orders = orders|sort(attribute='created_at', reverse=true) %}
        {% set sorted_orders = sorted_orders[:100] %}
        <div class="table-wrapper">
          <table border="1" cellpadding="5" cellspacing="0">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Order Date</th>
                <th>Delivery Time</th>
                <th>Fulfillment Status</th>
                <th>Customer</th>
                <th>Final Order Total <span class="info-badge" tabindex="0">&#9432;
  <span class="info-tooltip">Click this value to manually edit. Profit &amp; Profit Margin will be updated as well.</span>
</span></th>
                <th>Items</th>
                <th>Flower</th>
                <th>Discounts</th>
                <th>Profit</th>
                <th>Payment Method</th>
              </tr>
            </thead>
            <tbody>
              {% for order in sorted_orders %}
              <tr>
                <td><span class="bubble-gray">{{ order['id'] }}</span></td>
                <td>
                  {% if order['created_at'] %}
                    {% set dt = order['created_at'] %}
                    {% set year = dt[0:4]|int %}
                    {% set month = dt[5:7]|int %}
                    {% set day = dt[8:10]|int %}
                    {% set hour = dt[11:13]|int %}
                    {% set minute = dt[14:16]|int %}
                    {% set ampm = 'AM' %}
                    {# Convert UTC to Pacific Time (UTC-7 for DST, UTC-8 for Standard) #}
                    {% set month_for_dst = month %}
                    {% set day_for_dst = day %}
                    {% set dst_start = 8 %} {# Second Sunday in March is always between 8-14 #}
                    {% set dst_end = 1 %} {# First Sunday in November is always between 1-7 #}
                    {% set is_dst = (month_for_dst > 3 and month_for_dst < 11) or (month_for_dst == 3 and day_for_dst >= dst_start) or (month_for_dst == 11 and day_for_dst < dst_end) %}
                    {% set offset = -7 if is_dst else -8 %}
                    {% set hour_pacific = hour + offset %}
                    {% if hour_pacific < 0 %}
                      {% set hour_pacific = hour_pacific + 24 %}
                      {% set day = day - 1 %}
                      {# Not handling month/year underflow for simplicity #}
                    {% elif hour_pacific >= 24 %}
                      {% set hour_pacific = hour_pacific - 24 %}
                      {% set day = day + 1 %}
                      {# Not handling month/year overflow for simplicity #}
                    {% endif %}
                    {% set hour12 = hour_pacific if hour_pacific == 0 or hour_pacific == 12 else hour_pacific % 12 %}
                    {% set hour12 = 12 if hour12 == 0 else hour12 %}
                    {% set ampm = 'AM' if hour_pacific < 12 else 'PM' %}
                    {% set month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                    <span class="bubble-gray">{{ month_names[month-1] }} {{ day }}, {{ year }}<br>{{ '%d' % hour12 }}:{{ '%02d' % minute }} {{ ampm }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if order['delivery_time'] %}
                    {% set dt = order['delivery_time'] %}
                    {% set year = dt[0:4]|int %}
                    {% set month = dt[5:7]|int %}
                    {% set day = dt[8:10]|int %}
                    {% set hour = dt[11:13]|int %}
                    {% set minute = dt[14:16]|int %}
                    {% set hour12 = hour if hour == 0 or hour == 12 else hour % 12 %}
                    {% set hour12 = 12 if hour12 == 0 else hour12 %}
                    {% set ampm = 'AM' if hour < 12 else 'PM' %}
                    {% set month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                    <span class="bubble-gray">{{ month_names[month-1] }} {{ day }}, {{ year }}<br>{{ '%d' % hour12 }}:{{ '%02d' % minute }} {{ ampm }}</span>
                  {% endif %}
                </td>
                <td>
                  <div class="fulfillment-dropdown" style="position: relative; display: inline-block;">
                    <span class="bubble-gray fulfillment-bubble" tabindex="0" onclick="toggleDropdown(this)" data-order-id="{{ order['id'] }}"
  {% if order['fulfillment_status'] == 'Completed' %}class="bubble-gray fulfillment-bubble bubble-fulfillment-completed"{% elif order['fulfillment_status'] == 'Processing' %}class="bubble-gray fulfillment-bubble bubble-fulfillment-processing"{% elif order['fulfillment_status'] == 'Received' %}class="bubble-gray fulfillment-bubble bubble-fulfillment-received"{% elif order['fulfillment_status'] == 'Canceled' %}class="bubble-gray fulfillment-bubble bubble-fulfillment-canceled"{% endif %}>
  {{ order['fulfillment_status'] }}
</span>
                    <div class="dropdown-menu" style="display: none; position: absolute; left: 0; top: 110%; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-width: 140px; z-index: 10;">
                      <div class="dropdown-option" onclick="selectFulfillment(this, 'Received')">Received</div>
                      <div class="dropdown-option" onclick="selectFulfillment(this, 'Processing')">Processing</div>
                      <div class="dropdown-option" onclick="selectFulfillment(this, 'Canceled')">Canceled</div>
                      <div class="dropdown-option" onclick="selectFulfillment(this, 'Completed')">Completed</div>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="bubble-gray">&#128100; {{ order['full_name'] }}</span><br>
                  {% if order['phone'] %}<span class="bubble-gray">&#128222; {{ order['phone'] }}</span>{% endif %}
                  {% if order['email'] %}<br><span class="bubble-gray">&#9993; {{ order['email'] }}</span>{% endif %}
                  {% if order['address'] or order['city'] or order['state'] or order['zip'] %}<br><br><span class="bubble-gray">&#128205; {{ order['address'] }}</span><br><span class="bubble-gray">{{ order['city'] }}, {{ order['state'] }} {{ order['zip'] }}</span>{% endif %}
                </td>
                <td>{% if order['total'] is not none %}<span class="bubble">${{ '%.2f' % (order['total']|float) }}</span>{% endif %}</td>
                <td>
                  {% if order['items'] %}
                    {% set non_empty_items = order['items'] | selectattr('productID') | list %}
                    {% set items_json = non_empty_items | tojson %}
                    {% for item in non_empty_items %}
                      <span class="bubble-gray"><b>Product ID:</b> {{ item['productID'] }}</span>
                      {% if item['option'] %}<span class="bubble-gray">{{ item['option'] }}</span>{% endif %}
                      <br>
                      <span class="bubble-gray">{{ item['productName'] }}</span><br>
                      <span class="bubble" style="cursor:pointer;" data-items='{{ items_json|safe }}' data-index='{{ loop.index0 }}'><b>Quantity:</b> {{ item['quantity'] }}</span> <span class="bubble"><b>Total:</b> {{ item['total'] }}</span>{% if not loop.last %}<br><br>{% endif %}
                    {% endfor %}
                  {% endif %}
                </td>
                <td>
                  {% if order['flower'] %}
                    {% set non_empty_flower = order['flower'] | selectattr('productID') | list %}
                    {% set flower_json = non_empty_flower | tojson %}
                    {% for item in non_empty_flower %}
                      <span class="bubble-gray"><b>Product ID:</b> {{ item['productID'] }}</span>
                      {% if item['option'] %}<span class="bubble-gray">{{ item['option'] }}</span>{% endif %}
                      <br>
                      <span class="bubble-gray">{{ item['productName'] }}</span><br>
                      <span class="bubble" style="cursor:pointer;" data-items='{{ flower_json|safe }}' data-index='{{ loop.index0 }}'><b>Quantity:</b> {{ item['quantity'] }}g</span> <span class="bubble"><b>Total:</b> {{ item['total'] }}</span>{% if not loop.last %}<br><br>{% endif %}
                    {% endfor %}
                  {% endif %}
                </td>
                <td>
                  {% if order['total_discounts'] is not none and order['total_discounts']|float > 0 %}<span class="bubble"><b>Total:</b> ${{ '%.2f' % (order['total_discounts']|float) }}</span>{% endif %}{% if order['total_discounts'] is not none and order['total_discounts']|float > 0 %}<br>{% endif %}
                  {% if order['volume_discounts'] is not none and order['volume_discounts']|float > 0 %}<span class="bubble-light"><b>Flower:</b> ${{ '%.2f' % (order['volume_discounts']|float) }}</span>{% endif %}{% if order['volume_discounts'] is not none and order['volume_discounts']|float > 0 %}<br>{% endif %}
                  {% if order['BXGO_discounts'] is not none and order['BXGO_discounts']|float > 0 %}<span class="bubble-light"><b>BXGO:</b> ${{ '%.2f' % (order['BXGO_discounts']|float) }}</span>{% endif %}{% if order['BXGO_discounts'] is not none and order['BXGO_discounts']|float > 0 %}<br>{% endif %}
                  {% if order['promo_discounts'] is not none and order['promo_discounts']|float > 0 %}<span class="bubble-light"><b>Promo:</b> ${{ '%.2f' % (order['promo_discounts']|float) }}</span>{% endif %}
                </td>
                <td>
                  {% if order['order_profit'] is not none and order['order_profit']|float > 0 %}<span class="bubble"><b>Profit:</b> ${{ '%.2f' % (order['order_profit']|float) }}</span>{% endif %}
                  {% if order['profit_margin'] is not none and order['profit_margin']|float > 0 %}<span class="bubble-light"><b>Margin:</b> {{ (order['profit_margin']|float * 100) | round(0) | int }}%</span>{% endif %}
                </td>
                <td>{% if order['payment_method'] %}<span class="bubble-gray">{{ order['payment_method'] }}</span>{% endif %}</td>
              </tr>
            {% endfor %}
            {% if orders|length == 0 %}
              <tr><td colspan="13"><span class="bubble-gray">No orders found.</span></td></tr>
            {% endif %}
          </tbody>
        </table>
      {% else %}
        <p>No orders found.</p>
      {% endif %}
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Password protection for orders page using Supabase
  (async function() {
      if (!sessionStorage.getItem('admin_authed')) {
          let tries = 0;
          let passwords = [];
          try {
              const res = await fetch('/api/passwords');
              if (!res.ok) throw new Error('Could not fetch passwords');
              const data = await res.json();
              passwords = (data.passwords || data || []).map(row => row.password);
          } catch (e) {
              document.body.innerHTML = '<h2 style="color:red;text-align:center;margin-top:80px;">Could not verify password. Try again later.</h2>';
              throw new Error('Password fetch failed');
          }
          while (tries < 3) {
              const input = prompt('Enter admin password:');
              if (input === null) {
                  document.body.innerHTML = '<h2 style="color:red;text-align:center;margin-top:80px;">Access denied.</h2>';
                  throw new Error('Access denied');
              }
              if (passwords.includes(input)) {
                  sessionStorage.setItem('admin_authed', '1');
                  break;
              } else {
                  tries++;
                  if (tries >= 3) {
                      document.body.innerHTML = '<h2 style="color:red;text-align:center;margin-top:80px;">Access denied.</h2>';
                      throw new Error('Access denied');
                  }
                  alert('Incorrect password. Try again.');
              }
          }
      }
  })();
  // Product dropdown change event to update type options
  var productDropdown = document.getElementById('product-dropdown');
  var typeDropdown = document.getElementById('type-dropdown');

  async function updateTypeDropdown() {
    var selectedProductId = productDropdown.value;
    typeDropdown.innerHTML = '';
    typeDropdown.disabled = true;
    // Show loading
    var loadingOption = document.createElement('option');
    loadingOption.textContent = 'Loading...';
    loadingOption.disabled = true;
    loadingOption.selected = true;
    typeDropdown.appendChild(loadingOption);
    try {
      const resp = await fetch(`/api/product-options/${selectedProductId}`);
      if (!resp.ok) throw new Error('Failed to fetch product options');
      const data = await resp.json();
      let options = data.options || [];
      typeDropdown.innerHTML = '';
      if (options.length > 0) {
        options.forEach(function(opt) {
          var optionEl = document.createElement('option');
          optionEl.value = opt;
          optionEl.textContent = opt;
          typeDropdown.appendChild(optionEl);
        });
        typeDropdown.disabled = false;
      } else {
        var placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'No options';
        placeholder.disabled = true;
        placeholder.selected = true;
        typeDropdown.appendChild(placeholder);
        typeDropdown.disabled = true;
      }
    } catch (e) {
      typeDropdown.innerHTML = '';
      var errorOption = document.createElement('option');
      errorOption.value = '';
      errorOption.textContent = 'Error loading options';
      errorOption.disabled = true;
      errorOption.selected = true;
      typeDropdown.appendChild(errorOption);
      typeDropdown.disabled = true;
    }
  }
  if (productDropdown && typeDropdown) {
    productDropdown.addEventListener('change', updateTypeDropdown);
    updateTypeDropdown(); // initialize on load
  }

  // --- Product Searchable Dropdown ---
  const products = JSON.parse(document.getElementById('products-data').textContent);
  const productSearchInput = document.getElementById('product-search-input');
  const productSearchDropdown = document.getElementById('product-search-dropdown');
  let selectedProductIdx = 0;
  function renderProductDropdown(filterText = '') {
    let filtered = products.filter(p =>
      p.id.toLowerCase().includes(filterText.toLowerCase()) ||
      p.product_name.toLowerCase().includes(filterText.toLowerCase())
    );
    productSearchDropdown.innerHTML = '';
    if (filtered.length === 0) {
      productSearchDropdown.innerHTML = '<div style="padding:10px;color:#888;">No products found</div>';
    } else {
      filtered.forEach((p, idx) => {
        const div = document.createElement('div');
        div.textContent = `${p.id}: ${p.product_name}`;
        div.style.padding = '10px 18px';
        div.style.cursor = 'pointer';
        div.style.background = idx === selectedProductIdx ? '#e5e7eb' : '#fff';
        div.onmouseenter = () => { selectedProductIdx = idx; highlightDropdown(); };
        div.onclick = () => selectProduct(filtered[idx]);
        productSearchDropdown.appendChild(div);
      });
    }
    productSearchDropdown.style.display = 'block';
  }
  function highlightDropdown() {
    Array.from(productSearchDropdown.children).forEach((div, idx) => {
      div.style.background = idx === selectedProductIdx ? '#e5e7eb' : '#fff';
    });
  }
  function selectProduct(product) {
    productSearchInput.value = `${product.id}: ${product.product_name}`;
    productSearchInput.dataset.selectedId = product.id;
    productSearchDropdown.style.display = 'none';
    productSearchInput.dispatchEvent(new Event('change'));
  }
  productSearchInput.addEventListener('input', function(e) {
    selectedProductIdx = 0;
    renderProductDropdown(this.value);
  });
  productSearchInput.addEventListener('focus', function() {
    renderProductDropdown(this.value);
  });
  productSearchInput.addEventListener('blur', function() {
    setTimeout(() => { productSearchDropdown.style.display = 'none'; }, 150);
  });
  productSearchInput.addEventListener('keydown', function(e) {
    const visible = productSearchDropdown.style.display === 'block';
    if (!visible) return;
    const items = Array.from(productSearchDropdown.children);
    if (e.key === 'ArrowDown') {
      selectedProductIdx = Math.min(selectedProductIdx + 1, items.length - 1);
      highlightDropdown();
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      selectedProductIdx = Math.max(selectedProductIdx - 1, 0);
      highlightDropdown();
      e.preventDefault();
    } else if (e.key === 'Enter') {
      if (items[selectedProductIdx]) {
        items[selectedProductIdx].click();
        e.preventDefault();
      }
    }
  });
  function getSelectedProductId() {
    // Use the product-search-input's data-selected-id if set
    if (productSearchInput.dataset.selectedId) return productSearchInput.dataset.selectedId;
    const val = productSearchInput.value.trim();
    const found = products.find(p => `${p.id}: ${p.product_name}` === val);
    return found ? found.id : '';
  }

  // Manual Cart Add to Cart logic
  var addToCartBtn = document.getElementById('add-to-cart-btn');
  var quantityDropdown = document.getElementById('quantity-dropdown');
  function getManualCart() {
    return JSON.parse(localStorage.getItem('manual_cart')) || [];
  }
  function setManualCart(cart) {
    localStorage.setItem('manual_cart', JSON.stringify(cart));
  }
  function getSelectedProductId() {
    // Use the product-search-input's data-selected-id if set
    if (productSearchInput.dataset.selectedId) return productSearchInput.dataset.selectedId;
    const val = productSearchInput.value.trim();
    const found = products.find(p => `${p.id}: ${p.product_name}` === val);
    return found ? found.id : '';
  }
  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', async function() {
      var selectedProductId = productDropdown.value;
      if (!selectedProductId) {
        alert('Please select a product from the dropdown.');
        return;
      }
      var selectedProductOption = productDropdown.options[productDropdown.selectedIndex];
      var selectedProductName = selectedProductOption ? selectedProductOption.textContent : '';
      var selectedQuantity = parseInt(quantityDropdown.value);
      var selectedType = typeDropdown.value;
      // Fetch price and group from backend
      try {
        let url = `/api/product-options/${selectedProductId}`;
        if (selectedType) {
          url += `?option=${encodeURIComponent(selectedType)}`;
        }
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Failed to fetch product info');
        const data = await resp.json();
        let price = data.price;
        let group = data.group || data.productGroup || '';
        if (typeof price === 'undefined') {
          alert('Price not available for this product/option.');
          return;
        }
        let total = (price * selectedQuantity).toFixed(2);
        // Use the same structure as product_page.html addToCart
        var item = {
          productName: selectedProductName,
          productID: selectedProductId,
          quantity: selectedQuantity,
          total: `$${total}`,
          productGroup: group,
          option: selectedType || ''
        };
        var cart = getManualCart();
        cart.push(item);
        setManualCart(cart);
        // Debug: log backend data and cart item
        console.log('Backend data:', data);
        console.log('Cart item being added:', item);
        cart.forEach(function(it, idx) {
          console.log(`#${idx + 1}:`, it.productName, '| productGroup:', it.productGroup, '| group:', it.group, '| full:', it);
        });
        alert('Added to Manual Cart!');
      } catch (e) {
        alert('Error adding to cart: ' + e.message);
      }
    });
  }
  // --- Flower Dropdown for Duplicate Row ---
  const flowerDropdown = document.getElementById('flower-dropdown-duplicate');
  const flowerSearchInput = document.getElementById('flower-search-input');
  let allFlowers = [];
  if (flowerDropdown) {
    flowerDropdown.innerHTML = '<option value="" disabled selected>Loading flowers...</option>';
    fetch('/api/all-flower-options')
      .then(resp => resp.json())
      .then(data => {
        allFlowers = data.flowers || [];
        renderFlowerDropdown('');
      })
      .catch(() => {
        flowerDropdown.innerHTML = '';
        var opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Error loading flowers';
        opt.disabled = true;
        opt.selected = true;
        flowerDropdown.appendChild(opt);
      });
  }
  function renderFlowerDropdown(filterText) {
    flowerDropdown.innerHTML = '';
    let filtered = allFlowers.filter(f =>
      f.id.toString().toLowerCase().includes(filterText.toLowerCase()) ||
      (f.product_name && f.product_name.toLowerCase().includes(filterText.toLowerCase()))
    );
    if (filtered.length === 0) {
      var opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No flower products found';
      opt.disabled = true;
      opt.selected = true;
      flowerDropdown.appendChild(opt);
      return;
    }
    filtered.forEach(function(flower) {
      var option = document.createElement('option');
      option.value = flower.id;
      option.textContent = flower.id + ': ' + flower.product_name;
      flowerDropdown.appendChild(option);
    });
  }
  if (flowerSearchInput) {
    flowerSearchInput.addEventListener('input', function() {
      renderFlowerDropdown(this.value);
    });
  }
  // Add to Cart button for duplicate row (implement your logic here)
  document.getElementById('add-to-cart-btn-duplicate').addEventListener('click', async function() {
    const flowerId = flowerDropdown.value;
    const qty = parseInt(document.getElementById('quantity-dropdown-duplicate').value);
    if (!flowerId) {
      alert('Please select a flower product.');
      return;
    }
    // Find the selected flower's name
    let selectedFlowerOption = flowerDropdown.options[flowerDropdown.selectedIndex];
    let selectedFlowerName = selectedFlowerOption ? selectedFlowerOption.textContent : '';
    // Fetch price and group from backend
    try {
      let url = `/api/flower-options/${flowerId}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to fetch flower info');
      const data = await resp.json();
      // Try to get price per gram from various possible keys
      let price = data['price/g'] || data['price_per_g'] || data['price_g'] || data.price;
      let group = data.group || data.productGroup || 'Flower';
      let tier = data.price_tier || data.productTier || data.tier || '';
      if (typeof price === 'undefined') {
        alert('Price per gram not available for this flower.');
        return;
      }
      let total = (price * qty).toFixed(2);
      var item = {
        productName: selectedFlowerName,
        productID: flowerId,
        quantity: qty,
        total: `$${total}`,
        productGroup: group,
        option: '',
        flower_line_item: true,
        type: 'flower_line_item',
        productTier: tier
      };
      var cart = getManualCart();
      cart.push(item);
      setManualCart(cart);
      alert('Added flower to Manual Cart!');
    } catch (e) {
      alert('Error adding flower to cart: ' + e.message);
    }
  });
});
</script>
{% if flower_options %}
<script id="flower-options-data" type="application/json">{{ flower_options|tojson|safe }}</script>
{% endif %}
{% if products %}
<script id="products-data" type="application/json">{{ products|tojson|safe }}</script>
{% endif %}
</body>
</html>
